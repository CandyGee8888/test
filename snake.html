<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>經典貪食蛇 - 霓虹版</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --grid-color: #16213e;
            --snake-color: #0f3460;
            --snake-head: #e94560;
            --food-color: #4effef;
            --text-color: #ffffff;
            --accent-color: #e94560;
            --modal-bg: rgba(26, 26, 46, 0.95);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none; /* 防止手機上長按選取文字 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 2rem;
            text-shadow: 0 0 10px var(--accent-color);
            margin-bottom: 5px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 15px;
        }

        .stat-item span {
            font-weight: bold;
            color: var(--food-color);
        }

        /* 遊戲容器 */
        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #333;
            border-radius: 4px;
            background-color: var(--grid-color);
        }

        canvas {
            display: block;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; /* 對應 grid size */
        }

        /* 控制說明與虛擬按鍵 */
        .controls-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #aaa;
            text-align: center;
        }

        .d-pad {
            display: none; /* 預設隱藏，在小螢幕顯示 */
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(2, 60px);
            gap: 10px;
            margin-top: 20px;
        }

        .d-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .d-btn:active {
            background: var(--accent-color);
        }

        .d-btn.up { grid-column: 2; grid-row: 1; }
        .d-btn.left { grid-column: 1; grid-row: 2; }
        .d-btn.down { grid-column: 2; grid-row: 2; }
        .d-btn.right { grid-column: 3; grid-row: 2; }

        /* 模態框 (開始/結束畫面) */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .modal.hidden {
            display: none;
        }

        .modal h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .modal p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px var(--accent-color);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--accent-color);
        }

        .btn:active {
            transform: scale(0.95);
        }

        /* 響應式調整 */
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .stats-bar { font-size: 1rem; padding: 5px 15px; }
            .d-pad { display: grid; }
            .controls-info { display: none; } /* 手機上隱藏鍵盤說明 */
        }
    </style>
</head>
<body>

    <header>
        <h1>貪食蛇大作戰</h1>
        <div class="stats-bar">
            <div class="stat-item">分數: <span id="score">0</span></div>
            <div class="stat-item">最高分: <span id="high-score">0</span></div>
        </div>
    </header>

    <main>
        <div id="game-container">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            
            <!-- 開始畫面 -->
            <div id="start-screen" class="modal">
                <h2>準備好了嗎？</h2>
                <p>使用方向鍵或按鈕控制蛇移動</p>
                <button class="btn" onclick="startGame()">開始遊戲</button>
            </div>

            <!-- 遊戲結束畫面 -->
            <div id="game-over-screen" class="modal hidden">
                <h2>遊戲結束</h2>
                <p>最終得分: <span id="final-score">0</span></p>
                <button class="btn" onclick="startGame()">再玩一次</button>
            </div>
            
             <!-- 暫停畫面 -->
             <div id="pause-screen" class="modal hidden">
                <h2>已暫停</h2>
                <p>按空白鍵繼續</p>
                <button class="btn" onclick="togglePause()">繼續</button>
            </div>
        </div>

        <div class="controls-info">
            電腦：使用 ↑ ↓ ← → 移動，空白鍵暫停
        </div>

        <!-- 虛擬手把 (適用於手機) -->
        <div class="d-pad">
            <div class="d-btn up" ontouchstart="handleMobileInput('ArrowUp')" onmousedown="handleMobileInput('ArrowUp')">▲</div>
            <div class="d-btn left" ontouchstart="handleMobileInput('ArrowLeft')" onmousedown="handleMobileInput('ArrowLeft')">◀</div>
            <div class="d-btn down" ontouchstart="handleMobileInput('ArrowDown')" onmousedown="handleMobileInput('ArrowDown')">▼</div>
            <div class="d-btn right" ontouchstart="handleMobileInput('ArrowRight')" onmousedown="handleMobileInput('ArrowRight')">▶</div>
        </div>
    </main>

    <script>
        // 遊戲設定
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const finalScoreElement = document.getElementById('final-score');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const pauseScreen = document.getElementById('pause-screen');

        const gridSize = 20; // 網格大小
        const tileCount = canvas.width / gridSize; // 每行/列的格子數
        
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        highScoreElement.textContent = highScore;

        let velocityX = 0;
        let velocityY = 0;
        let snake = [];
        let food = { x: 5, y: 5 };
        let gameInterval;
        let isGameRunning = false;
        let isPaused = false;
        let speed = 150; // 初始速度
        let nextVelocityX = 0;
        let nextVelocityY = 0;

        // 初始化遊戲
        function initGame() {
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 }
            ];
            score = 0;
            speed = 150;
            velocityX = 1; // 初始向右移動
            velocityY = 0;
            nextVelocityX = 1;
            nextVelocityY = 0;
            scoreElement.textContent = score;
            placeFood();
        }

        // 開始遊戲
        function startGame() {
            initGame();
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            pauseScreen.classList.add('hidden');
            isGameRunning = true;
            isPaused = false;
            
            if (gameInterval) clearInterval(gameInterval);
            gameLoop();
        }

        // 遊戲主迴圈
        function gameLoop() {
            if (!isGameRunning) return;

            update();
            draw();
            
            // 根據速度調整計時器
            if (gameInterval) clearTimeout(gameInterval);
            gameInterval = setTimeout(gameLoop, speed);
        }

        // 更新狀態
        function update() {
            if (isPaused) return;

            // 更新速度（防止同一幀內快速按兩次鍵導致反向撞死）
            velocityX = nextVelocityX;
            velocityY = nextVelocityY;

            // 計算新的頭部位置
            const head = { x: snake[0].x + velocityX, y: snake[0].y + velocityY };

            // 檢查碰撞（牆壁或身體）
            if (checkCollision(head)) {
                gameOver();
                return;
            }

            // 移動蛇：將新頭部加入陣列最前面
            snake.unshift(head);

            // 檢查是否吃到食物
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.textContent = score;
                increaseSpeed();
                placeFood();
                // 吃到食物不移除尾巴，蛇變長
            } else {
                // 沒吃到食物，移除尾巴，維持長度
                snake.pop();
            }
        }

        // 繪圖
        function draw() {
            // 清除畫布
            ctx.fillStyle = '#16213e'; // 背景色
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 繪製食物
            ctx.fillStyle = '#4effef';
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#4effef";
            ctx.beginPath();
            ctx.arc(
                food.x * gridSize + gridSize / 2, 
                food.y * gridSize + gridSize / 2, 
                gridSize / 2 - 2, 
                0, 2 * Math.PI
            );
            ctx.fill();
            ctx.shadowBlur = 0; // 重置陰影

            // 繪製蛇
            snake.forEach((part, index) => {
                if (index === 0) {
                    // 蛇頭
                    ctx.fillStyle = '#e94560';
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = "#e94560";
                } else {
                    // 蛇身 (漸層色)
                    ctx.fillStyle = '#0f3460';
                    ctx.shadowBlur = 0;
                }

                ctx.fillRect(
                    part.x * gridSize + 1, 
                    part.y * gridSize + 1, 
                    gridSize - 2, 
                    gridSize - 2
                );
                
                // 繪製蛇眼睛 (僅在頭部)
                if (index === 0) {
                    ctx.fillStyle = 'white';
                    const eyeSize = 4;
                    // 根據方向調整眼睛位置 (簡單處理)
                    let eyeOffsetX = gridSize / 4;
                    let eyeOffsetY = gridSize / 4;
                    
                    ctx.fillRect(part.x * gridSize + eyeOffsetX, part.y * gridSize + eyeOffsetY, eyeSize, eyeSize);
                    ctx.fillRect(part.x * gridSize + gridSize - eyeOffsetX - eyeSize, part.y * gridSize + eyeOffsetY, eyeSize, eyeSize);
                }
            });
        }

        // 隨機放置食物
        function placeFood() {
            let validPosition = false;
            while (!validPosition) {
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);

                // 確保食物不會生成在蛇身上
                validPosition = true;
                for (let part of snake) {
                    if (part.x === food.x && part.y === food.y) {
                        validPosition = false;
                        break;
                    }
                }
            }
        }

        // 碰撞檢測
        function checkCollision(head) {
            // 撞牆
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                return true;
            }
            // 撞自己 (從身體部分開始檢查)
            for (let i = 0; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            return false;
        }

        // 遊戲結束
        function gameOver() {
            isGameRunning = false;
            finalScoreElement.textContent = score;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                highScoreElement.textContent = highScore;
            }

            gameOverScreen.classList.remove('hidden');
        }

        // 增加速度 (難度)
        function increaseSpeed() {
            if (speed > 50) {
                speed -= 2; // 每次吃到食物減少 2ms 延遲
            }
        }

        // 暫停功能
        function togglePause() {
            if (!isGameRunning || gameOverScreen.classList.contains('hidden') === false) return;
            
            isPaused = !isPaused;
            if (isPaused) {
                pauseScreen.classList.remove('hidden');
            } else {
                pauseScreen.classList.add('hidden');
                // 立即執行一次更新以避免卡頓感
                gameLoop(); 
            }
        }

        // 鍵盤輸入處理
        document.addEventListener('keydown', (e) => {
            // 防止方向鍵滾動頁面
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].indexOf(e.code) > -1) {
                e.preventDefault();
            }

            if (e.code === 'Space') {
                togglePause();
                return;
            }

            if (!isGameRunning || isPaused) return;

            handleInput(e.key);
        });

        // 統一輸入處理 (鍵盤與虛擬按鍵)
        function handleInput(key) {
            // 邏輯：不能直接掉頭 (例如向右時不能直接向左)
            // 使用 nextVelocity 來緩衝輸入
            
            switch(key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (velocityY !== 1) {
                        nextVelocityX = 0;
                        nextVelocityY = -1;
                    }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (velocityY !== -1) {
                        nextVelocityX = 0;
                        nextVelocityY = 1;
                    }
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (velocityX !== 1) {
                        nextVelocityX = -1;
                        nextVelocityY = 0;
                    }
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (velocityX !== -1) {
                        nextVelocityX = 1;
                        nextVelocityY = 0;
                    }
                    break;
            }
        }

        // 處理手機虛擬按鈕
        function handleMobileInput(direction) {
            if (!isGameRunning) return;
            handleInput(direction);
        }

        // 頁面載入後先繪製一次背景
        draw();

    </script>
</body>
</html>